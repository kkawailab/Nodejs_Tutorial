<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Node.jsã§MongoDBã€PostgreSQLã€Redisã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æºã‚’å­¦ã¶åŒ…æ‹¬çš„ãªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«">
    <meta name="keywords" content="Node.js, MongoDB, PostgreSQL, Redis, Mongoose, Sequelize, ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹, ORM">
    <title>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æºãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« - Node.js</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ—„ï¸</text></svg>">
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #339933;
            --secondary-color: #68217a;
            --accent-color: #f39c12;
            --dark-color: #2c3e50;
            --text-color: #333;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f8f9fa;
            padding-top: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        main {
            padding: 2rem 0;
            background: white;
            min-height: calc(100vh - 200px);
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: var(--dark-color);
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        h1 {
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 1rem;
            font-size: 2.5rem;
        }
        
        h2 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        h3 {
            font-size: 1.5rem;
            color: var(--secondary-color);
        }
        
        /* ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        code {
            background-color: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #d73a49;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        pre {
            background-color: #2d3748 !important;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            position: relative;
            box-shadow: var(--shadow);
        }
        
        pre code {
            background-color: transparent !important;
            padding: 0;
            color: #e2e8f0 !important;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Prism.js ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: #68d391;
        }
        
        .token.punctuation {
            color: #e2e8f0;
        }
        
        .token.property,
        .token.tag,
        .token.boolean,
        .token.number,
        .token.constant,
        .token.symbol,
        .token.deleted {
            color: #f6e05e;
        }
        
        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin,
        .token.inserted {
            color: #fc8181;
        }
        
        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string {
            color: #90cdf4;
        }
        
        .token.atrule,
        .token.attr-value,
        .token.keyword {
            color: #90cdf4;
        }
        
        .token.function,
        .token.class-name {
            color: #b794f6;
        }
        
        .token.regex,
        .token.important,
        .token.variable {
            color: #fbb6ce;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .table-responsive {
            margin: 1.5rem 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        table {
            margin-bottom: 0;
        }
        
        .table-dark th {
            background-color: var(--dark-color) !important;
            border-color: var(--border-color);
        }
        
        /* ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* è­¦å‘Šãƒ»ãƒ’ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ */
        .alert {
            margin: 1.5rem 0;
            padding: 1.5rem;
            border-radius: 8px;
            border: none;
            box-shadow: var(--shadow);
        }
        
        .alert-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            color: #e65100;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            color: #2e7d32;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
        }
        
        .info-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #2196f3;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            box-shadow: var(--shadow);
        }
        
        .tip-box {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            border-left: 4px solid #ff9800;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            box-shadow: var(--shadow);
        }
        
        .warning-box {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-left: 4px solid #f44336;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            box-shadow: var(--shadow);
        }
        
        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .comparison-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .comparison-item h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1rem;
        }
        
        .comparison-item h4 {
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 1rem;
        }
        
        .best-practices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .practice-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .practice-item h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1rem;
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .btn {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #2e7d32);
            border: none;
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(51, 153, 51, 0.3);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }
        
        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-menu li {
            margin: 0 1rem;
        }
        
        .nav-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .best-practices-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-toggle {
                display: block;
            }
            
            .nav-menu {
                position: fixed;
                top: 60px;
                left: -100%;
                width: 100%;
                height: calc(100vh - 60px);
                background: rgba(46, 125, 50, 0.95);
                flex-direction: column;
                justify-content: start;
                align-items: center;
                padding-top: 2rem;
                transition: left 0.3s ease;
            }
            
            .nav-menu.active {
                left: 0;
            }
            
            .nav-menu li {
                margin: 1rem 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" style="background: linear-gradient(135deg, #2e7d32 0%, #1976d2 100%); padding: 1rem 0; margin-bottom: 0;">
        <nav class="navbar" style="background: transparent;">
            <a href="index.html" class="logo" style="color: white;">Node.js Tutorial</a>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link" style="color: white;">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="nodejs-tutorial.html" class="nav-link" style="color: white;">Node.jsåŸºç¤</a></li>
                <li><a href="express-tutorial.html" class="nav-link" style="color: white;">Express.js</a></li>
                <li><a href="express-generator-tutorial.html" class="nav-link" style="color: white;">Express Generator</a></li>
                <li><a href="#" class="nav-link active" style="color: white; font-weight: bold;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº</a></li>
            </ul>
            <button class="nav-toggle" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã" style="color: white;">
                <i class="fas fa-bars"></i>
            </button>
        </nav>
    </header>

    <div class="container">
        <div style="background: linear-gradient(135deg, #2e7d32 0%, #1976d2 100%); margin: -2rem -2rem 2rem -2rem; padding: 3rem 2rem; text-align: center; color: white;">
            <h1 style="color: white; border-bottom: none; margin: 0;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æºãƒã‚¹ã‚¿ãƒ¼ã‚³ãƒ¼ã‚¹</h1>
            <p style="font-size: 1.2rem; margin: 1rem 0;">MongoDBã€PostgreSQLã€Redisã‚’ä½¿ã£ãŸæœ¬æ ¼çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨å®Ÿè£…</p>
            <div style="margin-top: 1.5rem;">
                <span style="margin: 0 1rem;"><i class="fas fa-clock"></i> ç´„ 4-5æ™‚é–“</span>
                <span style="margin: 0 1rem;"><i class="fas fa-signal"></i> ä¸Šç´š</span>
                <span style="margin: 0 1rem;"><i class="fas fa-calendar"></i> æœ€çµ‚æ›´æ–°: 2024å¹´</span>
            </div>
        </div>

        <main>
            <!-- Introduction -->
            <section id="introduction" class="tutorial-section">
                <h2>ã¯ã˜ã‚ã«</h2>
                <p>ç¾ä»£ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãŠã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ä¸å¯æ¬ ãªè¦ç´ ã§ã™ã€‚ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§æœ€ã‚‚äººæ°—ã®ã‚ã‚‹3ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚</p>
                
                <div class="info-box">
                    <h4><i class="fas fa-info-circle"></i> ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§å­¦ã¹ã‚‹ã“ã¨</h4>
                    <ul>
                        <li>MongoDBï¼ˆNoSQLï¼‰ã¨Mongooseã‚’ä½¿ã£ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæŒ‡å‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ“ä½œ</li>
                        <li>PostgreSQLï¼ˆSQLï¼‰ã¨Sequelizeã‚’ä½¿ã£ãŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç®¡ç†</li>
                        <li>Redisã‚’ä½¿ã£ãŸé«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…</li>
                        <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®åŸå‰‡ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</li>
                        <li>æœ¬ç•ªç’°å¢ƒã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°</li>
                    </ul>
                </div>

                <h3>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é¸æŠåŸºæº–</h3>
                <div class="comparison-grid">
                    <div class="comparison-item">
                        <h4>MongoDB</h4>
                        <ul>
                            <li>ã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¹ã§æŸ”è»Ÿãªãƒ‡ãƒ¼ã‚¿æ§‹é€ </li>
                            <li>æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒå®¹æ˜“</li>
                            <li>JSONãƒ©ã‚¤ã‚¯ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå½¢å¼</li>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æœ€é©</li>
                        </ul>
                    </div>
                    <div class="comparison-item">
                        <h4>PostgreSQL</h4>
                        <ul>
                            <li>ACIDæº–æ‹ ã®å¼·åŠ›ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³</li>
                            <li>è¤‡é›‘ãªã‚¯ã‚¨ãƒªã¨çµåˆã«å„ªã‚Œã‚‹</li>
                            <li>ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãŒé‡è¦ãªå ´åˆã«æœ€é©</li>
                            <li>è±Šå¯Œãªæ‹¡å¼µæ©Ÿèƒ½ã¨ãƒ‡ãƒ¼ã‚¿å‹</li>
                        </ul>
                    </div>
                    <div class="comparison-item">
                        <h4>Redis</h4>
                        <ul>
                            <li>ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢</li>
                            <li>è¶…é«˜é€Ÿãªèª­ã¿æ›¸ãæ€§èƒ½</li>
                            <li>ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«æœ€é©</li>
                            <li>Pub/Subæ©Ÿèƒ½ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- MongoDB and Mongoose -->
            <section id="mongodb-mongoose" class="tutorial-section">
                <h2>MongoDB ã¨ Mongoose</h2>
                <p>MongoDBã¯æœ€ã‚‚äººæ°—ã®ã‚ã‚‹NoSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã€Mongooseã¯ãã®ãŸã‚ã®å¼·åŠ›ãªODMï¼ˆObject Document Mapperï¼‰ã§ã™ã€‚</p>

                <h3>1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3>
                <pre><code class="language-bash"># MongoDBã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆmacOSï¼‰
brew tap mongodb/brew
brew install mongodb-community

# MongoDBã®èµ·å‹•
brew services start mongodb-community

# Mongooseã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install mongoose</code></pre>

                <h3>2. æ¥ç¶šè¨­å®š</h3>
                <p><strong>config/database.js</strong></p>
                <pre><code class="language-javascript">const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/myapp', {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    
    console.log(`MongoDB Connected: ${conn.connection.host}`);
    
    // æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
    mongoose.connection.on('error', err => {
      console.error('MongoDB connection error:', err);
    });
    
    mongoose.connection.on('disconnected', () => {
      console.log('MongoDB disconnected');
    });
    
    // ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³
    process.on('SIGINT', async () => {
      await mongoose.connection.close();
      process.exit(0);
    });
  } catch (error) {
    console.error('Error connecting to MongoDB:', error);
    process.exit(1);
  }
};

module.exports = connectDB;</code></pre>

                <h3>3. ã‚¹ã‚­ãƒ¼ãƒã¨ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©</h3>
                <p><strong>models/User.js</strong></p>
                <pre><code class="language-javascript">const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');

const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'åå‰ã¯å¿…é ˆã§ã™'],
    trim: true,
    maxlength: [50, 'åå‰ã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„']
  },
  email: {
    type: String,
    required: [true, 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™'],
    unique: true,
    lowercase: true,
    validate: {
      validator: function(v) {
        return /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(v);
      },
      message: 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
    }
  },
  password: {
    type: String,
    required: [true, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™'],
    minlength: [6, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„'],
    select: false // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã—ãªã„
  },
  role: {
    type: String,
    enum: ['user', 'admin'],
    default: 'user'
  },
  profile: {
    bio: String,
    avatar: String,
    social: {
      twitter: String,
      facebook: String,
      linkedin: String
    }
  },
  posts: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Post'
  }],
  createdAt: {
    type: Date,
    default: Date.now
  },
  lastLogin: Date,
  isActive: {
    type: Boolean,
    default: true
  }
}, {
  timestamps: true,
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¨­å®š
userSchema.index({ email: 1 });
userSchema.index({ createdAt: -1 });
userSchema.index({ name: 'text', 'profile.bio': 'text' });

// ä»®æƒ³ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
userSchema.virtual('fullName').get(function() {
  return this.name;
});

userSchema.virtual('postCount').get(function() {
  return this.posts.length;
});

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ - ä¿å­˜å‰ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
userSchema.pre('save', async function(next) {
  if (!this.isModified('password')) return next();
  
  try {
    const salt = await bcrypt.genSalt(10);
    this.password = await bcrypt.hash(this.password, salt);
    next();
  } catch (error) {
    next(error);
  }
});

// ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰
userSchema.methods.comparePassword = async function(candidatePassword) {
  return await bcrypt.compare(candidatePassword, this.password);
};

userSchema.methods.toJSON = function() {
  const obj = this.toObject();
  delete obj.password;
  delete obj.__v;
  return obj;
};

// é™çš„ãƒ¡ã‚½ãƒƒãƒ‰
userSchema.statics.findByEmail = function(email) {
  return this.findOne({ email: email.toLowerCase() });
};

userSchema.statics.findActiveUsers = function() {
  return this.find({ isActive: true });
};

const User = mongoose.model('User', userSchema);

module.exports = User;</code></pre>

                <p><strong>models/Post.js</strong></p>
                <pre><code class="language-javascript">const mongoose = require('mongoose');

const postSchema = new mongoose.Schema({
  title: {
    type: String,
    required: [true, 'ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™'],
    trim: true,
    maxlength: [100, 'ã‚¿ã‚¤ãƒˆãƒ«ã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„']
  },
  slug: {
    type: String,
    unique: true,
    lowercase: true
  },
  content: {
    type: String,
    required: [true, 'å†…å®¹ã¯å¿…é ˆã§ã™']
  },
  excerpt: {
    type: String,
    maxlength: [200, 'æŠœç²‹ã¯200æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„']
  },
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  category: {
    type: String,
    required: true,
    enum: ['æŠ€è¡“', 'ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«', 'ãƒ“ã‚¸ãƒã‚¹', 'ãã®ä»–']
  },
  tags: [{
    type: String,
    lowercase: true
  }],
  images: [{
    url: String,
    caption: String
  }],
  status: {
    type: String,
    enum: ['draft', 'published', 'archived'],
    default: 'draft'
  },
  views: {
    type: Number,
    default: 0
  },
  likes: [{
    user: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    },
    createdAt: {
      type: Date,
      default: Date.now
    }
  }],
  comments: [{
    user: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    },
    content: String,
    createdAt: {
      type: Date,
      default: Date.now
    }
  }],
  publishedAt: Date,
  metadata: {
    readTime: Number,
    seoTitle: String,
    seoDescription: String,
    seoKeywords: [String]
  }
}, {
  timestamps: true
});

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
postSchema.index({ slug: 1 });
postSchema.index({ author: 1, status: 1 });
postSchema.index({ tags: 1 });
postSchema.index({ title: 'text', content: 'text' });

// ä¿å­˜å‰ã«ã‚¹ãƒ©ãƒƒã‚°ã‚’ç”Ÿæˆ
postSchema.pre('save', function(next) {
  if (this.isModified('title')) {
    this.slug = this.title
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim();
  }
  
  // æŠœç²‹ã‚’è‡ªå‹•ç”Ÿæˆ
  if (!this.excerpt && this.content) {
    this.excerpt = this.content.substring(0, 197) + '...';
  }
  
  // èª­äº†æ™‚é–“ã‚’è¨ˆç®—ï¼ˆ1åˆ†ã‚ãŸã‚Š200æ–‡å­—ï¼‰
  if (this.content) {
    this.metadata.readTime = Math.ceil(this.content.length / 200);
  }
  
  next();
});

// å…¬é–‹æ™‚ã«æ—¥ä»˜ã‚’è¨­å®š
postSchema.pre('save', function(next) {
  if (this.isModified('status') && this.status === 'published' && !this.publishedAt) {
    this.publishedAt = new Date();
  }
  next();
});

// ãƒ¡ã‚½ãƒƒãƒ‰
postSchema.methods.incrementViews = async function() {
  this.views += 1;
  return this.save();
};

postSchema.methods.addComment = async function(userId, content) {
  this.comments.push({ user: userId, content });
  return this.save();
};

postSchema.methods.toggleLike = async function(userId) {
  const likeIndex = this.likes.findIndex(like => 
    like.user.toString() === userId.toString()
  );
  
  if (likeIndex > -1) {
    this.likes.splice(likeIndex, 1);
  } else {
    this.likes.push({ user: userId });
  }
  
  return this.save();
};

// é™çš„ãƒ¡ã‚½ãƒƒãƒ‰
postSchema.statics.findPublished = function() {
  return this.find({ status: 'published' })
    .sort('-publishedAt')
    .populate('author', 'name email');
};

postSchema.statics.findBySlug = function(slug) {
  return this.findOne({ slug })
    .populate('author', 'name email profile.avatar');
};

postSchema.statics.searchPosts = function(query) {
  return this.find(
    { $text: { $search: query } },
    { score: { $meta: 'textScore' } }
  ).sort({ score: { $meta: 'textScore' } });
};

const Post = mongoose.model('Post', postSchema);

module.exports = Post;</code></pre>

                <h3>4. CRUDæ“ä½œã®å®Ÿè£…</h3>
                <p><strong>controllers/userController.js</strong></p>
                <pre><code class="language-javascript">const User = require('../models/User');
const catchAsync = require('../utils/catchAsync');
const AppError = require('../utils/appError');

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
exports.getUsers = catchAsync(async (req, res, next) => {
  // ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼
  const query = User.find();
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  if (req.query.role) {
    query.where('role').equals(req.query.role);
  }
  
  if (req.query.active) {
    query.where('isActive').equals(req.query.active === 'true');
  }
  
  // æ¤œç´¢
  if (req.query.search) {
    query.where('name').regex(new RegExp(req.query.search, 'i'));
  }
  
  // ã‚½ãƒ¼ãƒˆ
  const sortBy = req.query.sortBy || '-createdAt';
  query.sort(sortBy);
  
  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
  const page = parseInt(req.query.page, 10) || 1;
  const limit = parseInt(req.query.limit, 10) || 10;
  const skip = (page - 1) * limit;
  
  query.skip(skip).limit(limit);
  
  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é¸æŠ
  if (req.query.fields) {
    const fields = req.query.fields.split(',').join(' ');
    query.select(fields);
  }
  
  // ãƒãƒ”ãƒ¥ãƒ¬ãƒ¼ãƒˆ
  query.populate('posts', 'title status publishedAt');
  
  // å®Ÿè¡Œ
  const users = await query;
  
  // ç·æ•°ã‚’å–å¾—
  const total = await User.countDocuments();
  
  res.json({
    status: 'success',
    results: users.length,
    total,
    page,
    pages: Math.ceil(total / limit),
    data: users
  });
});

// å˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
exports.getUser = catchAsync(async (req, res, next) => {
  const user = await User.findById(req.params.id)
    .populate({
      path: 'posts',
      select: 'title slug status publishedAt views',
      match: { status: 'published' },
      options: { sort: '-publishedAt', limit: 10 }
    });
  
  if (!user) {
    return next(new AppError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 404));
  }
  
  res.json({
    status: 'success',
    data: user
  });
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
exports.createUser = catchAsync(async (req, res, next) => {
  const newUser = await User.create({
    name: req.body.name,
    email: req.body.email,
    password: req.body.password,
    role: req.body.role
  });
  
  res.status(201).json({
    status: 'success',
    data: newUser
  });
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°
exports.updateUser = catchAsync(async (req, res, next) => {
  const allowedUpdates = ['name', 'email', 'profile', 'isActive'];
  const updates = Object.keys(req.body)
    .filter(key => allowedUpdates.includes(key))
    .reduce((obj, key) => {
      obj[key] = req.body[key];
      return obj;
    }, {});
  
  const user = await User.findByIdAndUpdate(
    req.params.id,
    updates,
    {
      new: true,
      runValidators: true
    }
  );
  
  if (!user) {
    return next(new AppError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 404));
  }
  
  res.json({
    status: 'success',
    data: user
  });
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
exports.deleteUser = catchAsync(async (req, res, next) => {
  const user = await User.findByIdAndDelete(req.params.id);
  
  if (!user) {
    return next(new AppError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 404));
  }
  
  res.status(204).json({
    status: 'success',
    data: null
  });
});

// çµ±è¨ˆæƒ…å ±
exports.getUserStats = catchAsync(async (req, res, next) => {
  const stats = await User.aggregate([
    {
      $match: { isActive: true }
    },
    {
      $group: {
        _id: '$role',
        count: { $sum: 1 },
        avgPostCount: { $avg: { $size: '$posts' } }
      }
    },
    {
      $sort: { count: -1 }
    }
  ]);
  
  const monthlySignups = await User.aggregate([
    {
      $group: {
        _id: {
          year: { $year: '$createdAt' },
          month: { $month: '$createdAt' }
        },
        count: { $sum: 1 }
      }
    },
    {
      $sort: { '_id.year': -1, '_id.month': -1 }
    },
    {
      $limit: 12
    }
  ]);
  
  res.json({
    status: 'success',
    data: {
      roleStats: stats,
      monthlySignups
    }
  });
});</code></pre>

                <h3>5. é«˜åº¦ãªã‚¯ã‚¨ãƒªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯</h3>
                <pre><code class="language-javascript">// è¤‡é›‘ãªã‚¢ã‚°ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³
const getPopularPosts = async () => {
  const posts = await Post.aggregate([
    // å…¬é–‹æ¸ˆã¿ã®æŠ•ç¨¿ã®ã¿
    { $match: { status: 'published' } },
    
    // æ—¥ä»˜ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆéå»30æ—¥ï¼‰
    {
      $match: {
        publishedAt: {
          $gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
        }
      }
    },
    
    // ã„ã„ã­æ•°ã‚’è¨ˆç®—
    {
      $addFields: {
        likeCount: { $size: '$likes' },
        commentCount: { $size: '$comments' }
      }
    },
    
    // äººæ°—åº¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
    {
      $addFields: {
        popularityScore: {
          $add: [
            { $multiply: ['$views', 0.1] },
            { $multiply: ['$likeCount', 2] },
            { $multiply: ['$commentCount', 3] }
          ]
        }
      }
    },
    
    // ã‚½ãƒ¼ãƒˆ
    { $sort: { popularityScore: -1 } },
    
    // ä¸Šä½10ä»¶ã‚’å–å¾—
    { $limit: 10 },
    
    // è‘—è€…æƒ…å ±ã‚’çµåˆ
    {
      $lookup: {
        from: 'users',
        localField: 'author',
        foreignField: '_id',
        as: 'author'
      }
    },
    
    // é…åˆ—ã‚’å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    { $unwind: '$author' },
    
    // å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿é¸æŠ
    {
      $project: {
        title: 1,
        slug: 1,
        excerpt: 1,
        author: {
          name: 1,
          email: 1,
          'profile.avatar': 1
        },
        category: 1,
        tags: 1,
        views: 1,
        likeCount: 1,
        commentCount: 1,
        popularityScore: 1,
        publishedAt: 1
      }
    }
  ]);
  
  return posts;
};

// ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨
const transferPost = async (postId, fromUserId, toUserId) => {
  const session = await mongoose.startSession();
  session.startTransaction();
  
  try {
    // æŠ•ç¨¿ã®è‘—è€…ã‚’æ›´æ–°
    const post = await Post.findByIdAndUpdate(
      postId,
      { author: toUserId },
      { session, new: true }
    );
    
    if (!post) {
      throw new Error('æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // å…ƒã®è‘—è€…ã‹ã‚‰æŠ•ç¨¿ã‚’å‰Šé™¤
    await User.findByIdAndUpdate(
      fromUserId,
      { $pull: { posts: postId } },
      { session }
    );
    
    // æ–°ã—ã„è‘—è€…ã«æŠ•ç¨¿ã‚’è¿½åŠ 
    await User.findByIdAndUpdate(
      toUserId,
      { $push: { posts: postId } },
      { session }
    );
    
    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒŸãƒƒãƒˆ
    await session.commitTransaction();
    session.endSession();
    
    return post;
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    await session.abortTransaction();
    session.endSession();
    throw error;
  }
};

// ãƒãƒ«ã‚¯æ“ä½œ
const bulkUpdatePosts = async (updates) => {
  const bulkOps = updates.map(update => ({
    updateOne: {
      filter: { _id: update.id },
      update: { $set: update.data },
      upsert: false
    }
  }));
  
  const result = await Post.bulkWrite(bulkOps);
  return result;
};</code></pre>
            </section>

            <!-- PostgreSQL and Sequelize -->
            <section id="postgresql-sequelize" class="tutorial-section">
                <h2>PostgreSQL ã¨ Sequelize</h2>
                <p>PostgreSQLã¯æœ€ã‚‚é«˜æ©Ÿèƒ½ãªã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã€Sequelizeã¯Node.jsç”¨ã®å¼·åŠ›ãªORMã§ã™ã€‚</p>

                <h3>1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3>
                <pre><code class="language-bash"># PostgreSQLã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆmacOSï¼‰
brew install postgresql
brew services start postgresql

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ
createdb myapp_development
createdb myapp_test
createdb myapp_production

# Sequelizeã¨å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install sequelize pg pg-hstore
npm install --save-dev sequelize-cli

# Sequelizeã®åˆæœŸåŒ–
npx sequelize-cli init</code></pre>

                <h3>2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <p><strong>config/config.js</strong></p>
                <pre><code class="language-javascript">require('dotenv').config();

module.exports = {
  development: {
    username: process.env.DB_USERNAME || 'postgres',
    password: process.env.DB_PASSWORD || null,
    database: process.env.DB_NAME || 'myapp_development',
    host: process.env.DB_HOST || '127.0.0.1',
    port: process.env.DB_PORT || 5432,
    dialect: 'postgres',
    logging: console.log,
    pool: {
      max: 5,
      min: 0,
      acquire: 30000,
      idle: 10000
    }
  },
  test: {
    username: process.env.DB_USERNAME || 'postgres',
    password: process.env.DB_PASSWORD || null,
    database: process.env.DB_NAME_TEST || 'myapp_test',
    host: process.env.DB_HOST || '127.0.0.1',
    dialect: 'postgres',
    logging: false
  },
  production: {
    use_env_variable: 'DATABASE_URL',
    dialect: 'postgres',
    dialectOptions: {
      ssl: {
        require: true,
        rejectUnauthorized: false
      }
    },
    logging: false,
    pool: {
      max: 10,
      min: 2,
      acquire: 30000,
      idle: 10000
    }
  }
};</code></pre>

                <h3>3. ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©</h3>
                <p><strong>models/index.js</strong></p>
                <pre><code class="language-javascript">const { Sequelize } = require('sequelize');
const config = require('../config/config.js')[process.env.NODE_ENV || 'development'];

let sequelize;
if (config.use_env_variable) {
  sequelize = new Sequelize(process.env[config.use_env_variable], config);
} else {
  sequelize = new Sequelize(config.database, config.username, config.password, config);
}

// ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const User = require('./user')(sequelize, Sequelize.DataTypes);
const Product = require('./product')(sequelize, Sequelize.DataTypes);
const Order = require('./order')(sequelize, Sequelize.DataTypes);
const OrderItem = require('./orderItem')(sequelize, Sequelize.DataTypes);
const Category = require('./category')(sequelize, Sequelize.DataTypes);
const Review = require('./review')(sequelize, Sequelize.DataTypes);

// ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾©
// User associations
User.hasMany(Order, { foreignKey: 'userId', as: 'orders' });
User.hasMany(Review, { foreignKey: 'userId', as: 'reviews' });

// Product associations
Product.belongsTo(Category, { foreignKey: 'categoryId', as: 'category' });
Product.hasMany(OrderItem, { foreignKey: 'productId', as: 'orderItems' });
Product.hasMany(Review, { foreignKey: 'productId', as: 'reviews' });

// Order associations
Order.belongsTo(User, { foreignKey: 'userId', as: 'user' });
Order.hasMany(OrderItem, { foreignKey: 'orderId', as: 'items' });

// OrderItem associations
OrderItem.belongsTo(Order, { foreignKey: 'orderId' });
OrderItem.belongsTo(Product, { foreignKey: 'productId', as: 'product' });

// Category associations
Category.hasMany(Product, { foreignKey: 'categoryId', as: 'products' });

// Review associations
Review.belongsTo(User, { foreignKey: 'userId', as: 'user' });
Review.belongsTo(Product, { foreignKey: 'productId', as: 'product' });

module.exports = {
  sequelize,
  Sequelize,
  User,
  Product,
  Order,
  OrderItem,
  Category,
  Review
};</code></pre>

                <p><strong>models/user.js</strong></p>
                <pre><code class="language-javascript">const bcrypt = require('bcryptjs');

module.exports = (sequelize, DataTypes) => {
  const User = sequelize.define('User', {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true
    },
    username: {
      type: DataTypes.STRING,
      allowNull: false,
      unique: true,
      validate: {
        len: [3, 30],
        isAlphanumeric: true
      }
    },
    email: {
      type: DataTypes.STRING,
      allowNull: false,
      unique: true,
      validate: {
        isEmail: true
      }
    },
    password: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        len: [6, 100]
      }
    },
    firstName: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        len: [1, 50]
      }
    },
    lastName: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        len: [1, 50]
      }
    },
    role: {
      type: DataTypes.ENUM('customer', 'admin', 'vendor'),
      defaultValue: 'customer'
    },
    isActive: {
      type: DataTypes.BOOLEAN,
      defaultValue: true
    },
    emailVerified: {
      type: DataTypes.BOOLEAN,
      defaultValue: false
    },
    emailVerificationToken: DataTypes.STRING,
    passwordResetToken: DataTypes.STRING,
    passwordResetExpires: DataTypes.DATE,
    lastLogin: DataTypes.DATE,
    profile: {
      type: DataTypes.JSONB,
      defaultValue: {},
      get() {
        return this.getDataValue('profile') || {};
      }
    },
    preferences: {
      type: DataTypes.JSONB,
      defaultValue: {
        notifications: {
          email: true,
          push: false
        },
        theme: 'light'
      }
    },
    address: {
      type: DataTypes.JSONB,
      defaultValue: {}
    }
  }, {
    tableName: 'users',
    timestamps: true,
    indexes: [
      {
        fields: ['email']
      },
      {
        fields: ['username']
      },
      {
        fields: ['createdAt']
      }
    ],
    hooks: {
      beforeCreate: async (user) => {
        user.password = await bcrypt.hash(user.password, 10);
      },
      beforeUpdate: async (user) => {
        if (user.changed('password')) {
          user.password = await bcrypt.hash(user.password, 10);
        }
      }
    }
  });

  // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰
  User.prototype.comparePassword = async function(password) {
    return bcrypt.compare(password, this.password);
  };

  User.prototype.getFullName = function() {
    return `${this.firstName} ${this.lastName}`;
  };

  User.prototype.toJSON = function() {
    const values = Object.assign({}, this.get());
    delete values.password;
    delete values.emailVerificationToken;
    delete values.passwordResetToken;
    delete values.passwordResetExpires;
    return values;
  };

  // ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰
  User.findByEmail = function(email) {
    return this.findOne({ where: { email } });
  };

  User.findActiveUsers = function() {
    return this.findAll({ 
      where: { isActive: true },
      order: [['createdAt', 'DESC']]
    });
  };

  return User;
};</code></pre>

                <p><strong>models/product.js</strong></p>
                <pre><code class="language-javascript">module.exports = (sequelize, DataTypes) => {
  const Product = sequelize.define('Product', {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true
    },
    name: {
      type: DataTypes.STRING,
      allowNull: false,
      validate: {
        len: [1, 200]
      }
    },
    slug: {
      type: DataTypes.STRING,
      unique: true
    },
    description: {
      type: DataTypes.TEXT,
      allowNull: false
    },
    price: {
      type: DataTypes.DECIMAL(10, 2),
      allowNull: false,
      validate: {
        min: 0
      }
    },
    compareAtPrice: {
      type: DataTypes.DECIMAL(10, 2),
      validate: {
        min: 0
      }
    },
    cost: {
      type: DataTypes.DECIMAL(10, 2),
      validate: {
        min: 0
      }
    },
    sku: {
      type: DataTypes.STRING,
      unique: true
    },
    barcode: DataTypes.STRING,
    trackQuantity: {
      type: DataTypes.BOOLEAN,
      defaultValue: true
    },
    quantity: {
      type: DataTypes.INTEGER,
      defaultValue: 0,
      validate: {
        min: 0
      }
    },
    weight: {
      type: DataTypes.DECIMAL(10, 2),
      validate: {
        min: 0
      }
    },
    weightUnit: {
      type: DataTypes.ENUM('kg', 'g', 'lb', 'oz'),
      defaultValue: 'kg'
    },
    status: {
      type: DataTypes.ENUM('active', 'draft', 'archived'),
      defaultValue: 'active'
    },
    images: {
      type: DataTypes.JSONB,
      defaultValue: []
    },
    tags: {
      type: DataTypes.ARRAY(DataTypes.STRING),
      defaultValue: []
    },
    metadata: {
      type: DataTypes.JSONB,
      defaultValue: {}
    },
    categoryId: {
      type: DataTypes.UUID,
      references: {
        model: 'categories',
        key: 'id'
      }
    }
  }, {
    tableName: 'products',
    timestamps: true,
    paranoid: true,
    indexes: [
      {
        fields: ['slug']
      },
      {
        fields: ['sku']
      },
      {
        fields: ['status']
      },
      {
        fields: ['categoryId']
      },
      {
        type: 'FULLTEXT',
        fields: ['name', 'description']
      }
    ],
    hooks: {
      beforeCreate: (product) => {
        if (!product.slug) {
          product.slug = product.name
            .toLowerCase()
            .replace(/[^\w\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim();
        }
      }
    }
  });

  // ã‚¹ã‚³ãƒ¼ãƒ—
  Product.addScope('active', {
    where: { status: 'active' }
  });

  Product.addScope('inStock', {
    where: {
      [sequelize.Sequelize.Op.or]: [
        { trackQuantity: false },
        { quantity: { [sequelize.Sequelize.Op.gt]: 0 } }
      ]
    }
  });

  Product.addScope('withCategory', {
    include: [{
      model: sequelize.models.Category,
      as: 'category'
    }]
  });

  // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰
  Product.prototype.isInStock = function() {
    return !this.trackQuantity || this.quantity > 0;
  };

  Product.prototype.updateStock = async function(quantity, operation = 'decrease') {
    if (!this.trackQuantity) return this;
    
    if (operation === 'decrease') {
      if (this.quantity < quantity) {
        throw new Error('åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
      }
      this.quantity -= quantity;
    } else {
      this.quantity += quantity;
    }
    
    return this.save();
  };

  return Product;
};</code></pre>

                <h3>4. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
                <p><strong>migrations/20240101000001-create-users-table.js</strong></p>
                <pre><code class="language-javascript">module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('users', {
      id: {
        type: Sequelize.UUID,
        defaultValue: Sequelize.UUIDV4,
        primaryKey: true,
        allowNull: false
      },
      username: {
        type: Sequelize.STRING,
        allowNull: false,
        unique: true
      },
      email: {
        type: Sequelize.STRING,
        allowNull: false,
        unique: true
      },
      password: {
        type: Sequelize.STRING,
        allowNull: false
      },
      firstName: {
        type: Sequelize.STRING,
        allowNull: false
      },
      lastName: {
        type: Sequelize.STRING,
        allowNull: false
      },
      role: {
        type: Sequelize.ENUM('customer', 'admin', 'vendor'),
        defaultValue: 'customer'
      },
      isActive: {
        type: Sequelize.BOOLEAN,
        defaultValue: true
      },
      emailVerified: {
        type: Sequelize.BOOLEAN,
        defaultValue: false
      },
      emailVerificationToken: Sequelize.STRING,
      passwordResetToken: Sequelize.STRING,
      passwordResetExpires: Sequelize.DATE,
      lastLogin: Sequelize.DATE,
      profile: {
        type: Sequelize.JSONB,
        defaultValue: {}
      },
      preferences: {
        type: Sequelize.JSONB,
        defaultValue: {}
      },
      address: {
        type: Sequelize.JSONB,
        defaultValue: {}
      },
      createdAt: {
        type: Sequelize.DATE,
        allowNull: false
      },
      updatedAt: {
        type: Sequelize.DATE,
        allowNull: false
      }
    });

    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 
    await queryInterface.addIndex('users', ['email']);
    await queryInterface.addIndex('users', ['username']);
    await queryInterface.addIndex('users', ['createdAt']);
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable('users');
  }
};</code></pre>

                <h3>5. é«˜åº¦ãªã‚¯ã‚¨ãƒªã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <p><strong>controllers/productController.js</strong></p>
                <pre><code class="language-javascript">const { Product, Category, Review, OrderItem, sequelize } = require('../models');
const { Op } = require('sequelize');

// å•†å“æ¤œç´¢ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã‚½ãƒ¼ãƒˆã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
exports.searchProducts = async (req, res) => {
  try {
    const {
      q,
      category,
      minPrice,
      maxPrice,
      tags,
      inStock,
      sortBy = 'createdAt',
      order = 'DESC',
      page = 1,
      limit = 20
    } = req.query;

    // WHEREå¥ã®æ§‹ç¯‰
    const where = {};
    
    // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
    if (q) {
      where[Op.or] = [
        { name: { [Op.iLike]: `%${q}%` } },
        { description: { [Op.iLike]: `%${q}%` } }
      ];
    }
    
    // ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (minPrice || maxPrice) {
      where.price = {};
      if (minPrice) where.price[Op.gte] = minPrice;
      if (maxPrice) where.price[Op.lte] = maxPrice;
    }
    
    // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (tags) {
      const tagArray = Array.isArray(tags) ? tags : tags.split(',');
      where.tags = { [Op.contains]: tagArray };
    }
    
    // åœ¨åº«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (inStock === 'true') {
      where[Op.or] = [
        { trackQuantity: false },
        { quantity: { [Op.gt]: 0 } }
      ];
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å¸¸ã«activeã®ã¿
    where.status = 'active';

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    const include = [{
      model: Category,
      as: 'category',
      where: category ? { slug: category } : undefined,
      required: !!category
    }];

    // ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
    const products = await Product.findAndCountAll({
      where,
      include,
      order: [[sortBy, order]],
      limit: parseInt(limit),
      offset: (parseInt(page) - 1) * parseInt(limit),
      distinct: true,
      subQuery: false
    });

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    res.json({
      success: true,
      data: products.rows,
      pagination: {
        total: products.count,
        page: parseInt(page),
        pages: Math.ceil(products.count / parseInt(limit)),
        limit: parseInt(limit)
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};

// å•†å“è©³ç´°ã¨é–¢é€£æƒ…å ±ã®å–å¾—
exports.getProductDetail = async (req, res) => {
  try {
    const product = await Product.findOne({
      where: { slug: req.params.slug },
      include: [
        {
          model: Category,
          as: 'category',
          attributes: ['id', 'name', 'slug']
        },
        {
          model: Review,
          as: 'reviews',
          attributes: ['id', 'rating', 'comment', 'createdAt'],
          include: [{
            model: User,
            as: 'user',
            attributes: ['id', 'firstName', 'lastName']
          }],
          limit: 10,
          order: [['createdAt', 'DESC']]
        }
      ]
    });

    if (!product) {
      return res.status(404).json({
        success: false,
        error: 'å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
      });
    }

    // é–¢é€£å•†å“ã®å–å¾—
    const relatedProducts = await Product.findAll({
      where: {
        categoryId: product.categoryId,
        id: { [Op.ne]: product.id },
        status: 'active'
      },
      limit: 4,
      order: sequelize.random()
    });

    // å£²ä¸Šçµ±è¨ˆ
    const salesStats = await OrderItem.findOne({
      where: { productId: product.id },
      attributes: [
        [sequelize.fn('COUNT', sequelize.col('id')), 'totalOrders'],
        [sequelize.fn('SUM', sequelize.col('quantity')), 'totalSold'],
        [sequelize.fn('AVG', sequelize.col('price')), 'avgPrice']
      ],
      raw: true
    });

    res.json({
      success: true,
      data: {
        product,
        relatedProducts,
        salesStats
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};

// åœ¨åº«ã®ä¸€æ‹¬æ›´æ–°ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰
exports.bulkUpdateStock = async (req, res) => {
  const t = await sequelize.transaction();
  
  try {
    const updates = req.body.updates; // [{ productId, quantity, operation }]
    
    for (const update of updates) {
      const product = await Product.findByPk(update.productId, {
        transaction: t,
        lock: t.LOCK.UPDATE
      });
      
      if (!product) {
        throw new Error(`å•†å“ID ${update.productId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      }
      
      if (update.operation === 'set') {
        product.quantity = update.quantity;
      } else if (update.operation === 'increase') {
        product.quantity += update.quantity;
      } else if (update.operation === 'decrease') {
        if (product.quantity < update.quantity) {
          throw new Error(`å•†å“ ${product.name} ã®åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™`);
        }
        product.quantity -= update.quantity;
      }
      
      await product.save({ transaction: t });
    }
    
    await t.commit();
    
    res.json({
      success: true,
      message: 'åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ'
    });
  } catch (error) {
    await t.rollback();
    res.status(400).json({
      success: false,
      error: error.message
    });
  }
};

// å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆï¼ˆé›†è¨ˆã‚¯ã‚¨ãƒªï¼‰
exports.getSalesReport = async (req, res) => {
  try {
    const { startDate, endDate, groupBy = 'day' } = req.query;
    
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    let dateFormat;
    switch (groupBy) {
      case 'day':
        dateFormat = 'YYYY-MM-DD';
        break;
      case 'week':
        dateFormat = 'IYYY-IW';
        break;
      case 'month':
        dateFormat = 'YYYY-MM';
        break;
      default:
        dateFormat = 'YYYY-MM-DD';
    }
    
    const salesData = await OrderItem.findAll({
      attributes: [
        [sequelize.fn('DATE_TRUNC', groupBy, sequelize.col('OrderItem.createdAt')), 'period'],
        [sequelize.fn('COUNT', sequelize.col('OrderItem.id')), 'orderCount'],
        [sequelize.fn('SUM', sequelize.col('quantity')), 'totalQuantity'],
        [sequelize.fn('SUM', sequelize.literal('quantity * price')), 'totalRevenue']
      ],
      include: [{
        model: Product,
        as: 'product',
        attributes: []
      }],
      where: {
        createdAt: {
          [Op.between]: [startDate || '2020-01-01', endDate || new Date()]
        }
      },
      group: ['period'],
      order: [['period', 'ASC']],
      raw: true
    });
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥å£²ä¸Š
    const categoryData = await OrderItem.findAll({
      attributes: [
        [sequelize.col('product.category.name'), 'categoryName'],
        [sequelize.fn('SUM', sequelize.col('quantity')), 'totalQuantity'],
        [sequelize.fn('SUM', sequelize.literal('OrderItem.quantity * OrderItem.price')), 'totalRevenue']
      ],
      include: [{
        model: Product,
        as: 'product',
        attributes: [],
        include: [{
          model: Category,
          as: 'category',
          attributes: []
        }]
      }],
      where: {
        createdAt: {
          [Op.between]: [startDate || '2020-01-01', endDate || new Date()]
        }
      },
      group: ['product.category.id', 'product.category.name'],
      order: [[sequelize.literal('totalRevenue'), 'DESC']],
      raw: true
    });
    
    res.json({
      success: true,
      data: {
        salesData,
        categoryData
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};</code></pre>
            </section>

            <!-- Redis Caching -->
            <section id="redis-caching" class="tutorial-section">
                <h2>Redis ã§ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°</h2>
                <p>Redisã¯é«˜é€Ÿãªã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã§ã€ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã®å®Ÿè£…ã«æœ€é©ã§ã™ã€‚</p>

                <h3>1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3>
                <pre><code class="language-bash"># Redisã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆmacOSï¼‰
brew install redis
brew services start redis

# Node.jsã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install redis ioredis</code></pre>

                <h3>2. Redisæ¥ç¶šã®è¨­å®š</h3>
                <p><strong>config/redis.js</strong></p>
                <pre><code class="language-javascript">const Redis = require('ioredis');

// Redisæ¥ç¶šã®ä½œæˆ
const redis = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: process.env.REDIS_PORT || 6379,
  password: process.env.REDIS_PASSWORD,
  db: process.env.REDIS_DB || 0,
  retryStrategy: (times) => {
    const delay = Math.min(times * 50, 2000);
    return delay;
  },
  maxRetriesPerRequest: 3
});

// æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆ
redis.on('connect', () => {
  console.log('Redis connected');
});

redis.on('error', (err) => {
  console.error('Redis error:', err);
});

// Pub/Subç”¨ã®åˆ¥æ¥ç¶š
const pubClient = redis.duplicate();
const subClient = redis.duplicate();

module.exports = {
  redis,
  pubClient,
  subClient
};</code></pre>

                <h3>3. ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢</h3>
                <p><strong>middleware/cache.js</strong></p>
                <pre><code class="language-javascript">const { redis } = require('../config/redis');

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®ç”Ÿæˆ
const generateCacheKey = (req) => {
  const { originalUrl, method } = req;
  const userId = req.user?.id || 'anonymous';
  return `cache:${method}:${originalUrl}:${userId}`;
};

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
const cache = (duration = 300) => {
  return async (req, res, next) => {
    // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„
    if (req.method !== 'GET') {
      return next();
    }
    
    const key = generateCacheKey(req);
    
    try {
      const cachedData = await redis.get(key);
      
      if (cachedData) {
        const data = JSON.parse(cachedData);
        console.log('Cache hit:', key);
        return res.json(data);
      }
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯æ¬¡ã¸
      console.log('Cache miss:', key);
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ
      const originalJson = res.json;
      res.json = function(data) {
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        redis.setex(key, duration, JSON.stringify(data))
          .catch(err => console.error('Cache set error:', err));
        
        // å…ƒã®jsonãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶
        originalJson.call(this, data);
      };
      
      next();
    } catch (error) {
      console.error('Cache middleware error:', error);
      next();
    }
  };
};

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç„¡åŠ¹åŒ–
const invalidateCache = (pattern) => {
  return async (req, res, next) => {
    try {
      const keys = await redis.keys(`cache:*${pattern}*`);
      if (keys.length > 0) {
        await redis.del(keys);
        console.log(`Invalidated ${keys.length} cache keys`);
      }
      next();
    } catch (error) {
      console.error('Cache invalidation error:', error);
      next();
    }
  };
};

// ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
class TaggedCache {
  constructor(redis) {
    this.redis = redis;
  }
  
  async set(key, value, tags = [], ttl = 300) {
    const pipeline = this.redis.pipeline();
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    pipeline.setex(key, ttl, JSON.stringify(value));
    
    // ã‚¿ã‚°ã¨ã‚­ãƒ¼ã®é–¢é€£ä»˜ã‘
    for (const tag of tags) {
      pipeline.sadd(`tag:${tag}`, key);
      pipeline.expire(`tag:${tag}`, ttl);
    }
    
    await pipeline.exec();
  }
  
  async get(key) {
    const data = await this.redis.get(key);
    return data ? JSON.parse(data) : null;
  }
  
  async invalidateTag(tag) {
    const keys = await this.redis.smembers(`tag:${tag}`);
    
    if (keys.length > 0) {
      const pipeline = this.redis.pipeline();
      
      // ã‚­ãƒ¼ã‚’å‰Šé™¤
      for (const key of keys) {
        pipeline.del(key);
      }
      
      // ã‚¿ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
      pipeline.del(`tag:${tag}`);
      
      await pipeline.exec();
      console.log(`Invalidated ${keys.length} keys for tag: ${tag}`);
    }
  }
}

const taggedCache = new TaggedCache(redis);

module.exports = {
  cache,
  invalidateCache,
  taggedCache
};</code></pre>

                <h3>4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</h3>
                <p><strong>config/session.js</strong></p>
                <pre><code class="language-javascript">const session = require('express-session');
const RedisStore = require('connect-redis')(session);
const { redis } = require('./redis');

const sessionConfig = {
  store: new RedisStore({
    client: redis,
    prefix: 'sess:',
  }),
  secret: process.env.SESSION_SECRET || 'your-secret-key',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true,
    maxAge: 1000 * 60 * 60 * 24 * 7, // 1é€±é–“
    sameSite: 'lax'
  },
  name: 'sessionId'
};

module.exports = sessionConfig;</code></pre>

                <h3>5. ãƒ¬ãƒ¼ãƒˆåˆ¶é™</h3>
                <p><strong>middleware/rateLimiter.js</strong></p>
                <pre><code class="language-javascript">const { redis } = require('../config/redis');

// ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ–¹å¼ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
const rateLimiter = (options = {}) => {
  const {
    windowMs = 60000, // 1åˆ†
    max = 100, // æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
    keyGenerator = (req) => req.ip,
    skipSuccessfulRequests = false,
    skipFailedRequests = false,
    message = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'
  } = options;
  
  return async (req, res, next) => {
    const key = `rate:${keyGenerator(req)}`;
    const now = Date.now();
    const windowStart = now - windowMs;
    
    try {
      const pipeline = redis.pipeline();
      
      // å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
      pipeline.zremrangebyscore(key, '-inf', windowStart);
      
      // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’å–å¾—
      pipeline.zcard(key);
      
      // æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ 
      pipeline.zadd(key, now, `${now}-${Math.random()}`);
      
      // TTLã‚’è¨­å®š
      pipeline.expire(key, Math.ceil(windowMs / 1000));
      
      const results = await pipeline.exec();
      const requestCount = results[1][1];
      
      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
      if (requestCount >= max) {
        res.setHeader('X-RateLimit-Limit', max);
        res.setHeader('X-RateLimit-Remaining', 0);
        res.setHeader('X-RateLimit-Reset', new Date(now + windowMs).toISOString());
        
        return res.status(429).json({
          error: message,
          retryAfter: Math.ceil(windowMs / 1000)
        });
      }
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
      res.setHeader('X-RateLimit-Limit', max);
      res.setHeader('X-RateLimit-Remaining', max - requestCount - 1);
      res.setHeader('X-RateLimit-Reset', new Date(now + windowMs).toISOString());
      
      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†å¾Œã®å‡¦ç†
      res.on('finish', () => {
        if (
          (skipSuccessfulRequests && res.statusCode < 400) ||
          (skipFailedRequests && res.statusCode >= 400)
        ) {
          // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰å‰Šé™¤
          redis.zrem(key, `${now}-${Math.random()}`);
        }
      });
      
      next();
    } catch (error) {
      console.error('Rate limiter error:', error);
      next(); // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€šã™
    }
  };
};

// APIåˆ¥ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
const apiLimiter = rateLimiter({
  windowMs: 15 * 60 * 1000, // 15åˆ†
  max: 100,
  keyGenerator: (req) => `api:${req.ip}:${req.user?.id || 'anonymous'}`
});

// èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
const authLimiter = rateLimiter({
  windowMs: 15 * 60 * 1000, // 15åˆ†
  max: 5,
  keyGenerator: (req) => `auth:${req.ip}`,
  skipSuccessfulRequests: true
});

module.exports = {
  rateLimiter,
  apiLimiter,
  authLimiter
};</code></pre>

                <h3>6. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ï¼ˆPub/Subï¼‰</h3>
                <p><strong>services/realtime.js</strong></p>
                <pre><code class="language-javascript">const { pubClient, subClient } = require('../config/redis');
const EventEmitter = require('events');

class RealtimeService extends EventEmitter {
  constructor() {
    super();
    this.channels = new Map();
    this.setupSubscriber();
  }
  
  setupSubscriber() {
    subClient.on('message', (channel, message) => {
      try {
        const data = JSON.parse(message);
        this.emit(channel, data);
        
        // ãƒãƒ£ãƒ³ãƒãƒ«å›ºæœ‰ã®ãƒªã‚¹ãƒŠãƒ¼ã«é€šçŸ¥
        const listeners = this.channels.get(channel) || [];
        listeners.forEach(listener => listener(data));
      } catch (error) {
        console.error('Message parse error:', error);
      }
    });
  }
  
  // ãƒãƒ£ãƒ³ãƒãƒ«ã®è³¼èª­
  async subscribe(channel, callback) {
    if (!this.channels.has(channel)) {
      this.channels.set(channel, []);
      await subClient.subscribe(channel);
    }
    
    this.channels.get(channel).push(callback);
    
    // ã‚¢ãƒ³ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–é–¢æ•°ã‚’è¿”ã™
    return () => {
      const listeners = this.channels.get(channel);
      const index = listeners.indexOf(callback);
      if (index > -1) {
        listeners.splice(index, 1);
        
        // ãƒªã‚¹ãƒŠãƒ¼ãŒãªããªã£ãŸã‚‰ã‚¢ãƒ³ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–
        if (listeners.length === 0) {
          this.channels.delete(channel);
          subClient.unsubscribe(channel);
        }
      }
    };
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç™ºè¡Œ
  async publish(channel, data) {
    await pubClient.publish(channel, JSON.stringify(data));
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥
  async notifyUser(userId, notification) {
    await this.publish(`user:${userId}`, {
      type: 'notification',
      data: notification,
      timestamp: new Date()
    });
  }
  
  // ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
  async broadcast(event, data) {
    await this.publish('broadcast', {
      event,
      data,
      timestamp: new Date()
    });
  }
}

const realtimeService = new RealtimeService();

// WebSocketã¨ã®çµ±åˆä¾‹
const setupWebSocket = (io) => {
  io.on('connection', (socket) => {
    console.log('Client connected:', socket.id);
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è³¼èª­
    socket.on('authenticate', async (userId) => {
      socket.userId = userId;
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è³¼èª­
      const unsubscribe = await realtimeService.subscribe(
        `user:${userId}`,
        (data) => {
          socket.emit('message', data);
        }
      );
      
      // åˆ‡æ–­æ™‚ã«ã‚¢ãƒ³ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–
      socket.on('disconnect', () => {
        unsubscribe();
      });
    });
    
    // ãƒ«ãƒ¼ãƒ ã¸ã®å‚åŠ 
    socket.on('join-room', async (roomId) => {
      socket.join(roomId);
      
      const unsubscribe = await realtimeService.subscribe(
        `room:${roomId}`,
        (data) => {
          io.to(roomId).emit('room-message', data);
        }
      );
      
      socket.on('leave-room', () => {
        socket.leave(roomId);
        unsubscribe();
      });
    });
  });
};

module.exports = {
  realtimeService,
  setupWebSocket
};</code></pre>

                <h3>7. ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ </h3>
                <p><strong>services/queue.js</strong></p>
                <pre><code class="language-javascript">const Bull = require('bull');
const { redis } = require('../config/redis');

// ã‚­ãƒ¥ãƒ¼ã®ä½œæˆ
const emailQueue = new Bull('email', {
  redis: {
    host: redis.options.host,
    port: redis.options.port,
    password: redis.options.password
  }
});

const imageQueue = new Bull('image-processing', {
  redis: {
    host: redis.options.host,
    port: redis.options.port,
    password: redis.options.password
  }
});

// ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¸ãƒ§ãƒ–ã®å‡¦ç†
emailQueue.process(async (job) => {
  const { to, subject, template, data } = job.data;
  
  console.log(`Sending email to ${to}`);
  
  // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯
  await sendEmail(to, subject, template, data);
  
  return { sent: true, timestamp: new Date() };
});

// ç”»åƒå‡¦ç†ã‚¸ãƒ§ãƒ–
imageQueue.process(async (job) => {
  const { imagePath, sizes } = job.data;
  
  console.log(`Processing image: ${imagePath}`);
  
  // ç”»åƒãƒªã‚µã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯
  const results = await resizeImage(imagePath, sizes);
  
  return results;
});

// ã‚¸ãƒ§ãƒ–ã®è¿½åŠ 
const addEmailJob = async (emailData) => {
  const job = await emailQueue.add(emailData, {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 2000
    }
  });
  
  return job.id;
};

const addImageJob = async (imageData) => {
  const job = await imageQueue.add(imageData, {
    priority: imageData.priority || 0,
    delay: imageData.delay || 0
  });
  
  return job.id;
};

// ã‚¸ãƒ§ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–
emailQueue.on('completed', (job, result) => {
  console.log(`Email job ${job.id} completed:`, result);
});

emailQueue.on('failed', (job, err) => {
  console.error(`Email job ${job.id} failed:`, err);
});

module.exports = {
  emailQueue,
  imageQueue,
  addEmailJob,
  addImageJob
};</code></pre>
            </section>

            <!-- ORM and Query Optimization -->
            <section id="orm-optimization" class="tutorial-section">
                <h2>ORMã¨ã‚¯ã‚¨ãƒªæœ€é©åŒ–</h2>
                <p>ORMã‚’åŠ¹ç‡çš„ã«ä½¿ç”¨ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã™ã‚‹ãŸã‚ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å­¦ã³ã¾ã™ã€‚</p>

                <h3>1. N+1å•é¡Œã®è§£æ±º</h3>
                <pre><code class="language-javascript">// æ‚ªã„ä¾‹ï¼šN+1å•é¡ŒãŒç™ºç”Ÿ
const posts = await Post.findAll();
for (const post of posts) {
  post.author = await User.findByPk(post.authorId); // Nå›ã®ã‚¯ã‚¨ãƒª
}

// è‰¯ã„ä¾‹ï¼šEager Loading
const posts = await Post.findAll({
  include: [{
    model: User,
    as: 'author',
    attributes: ['id', 'name', 'email'] // å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿
  }]
});

// ã•ã‚‰ã«æœ€é©åŒ–ï¼šãƒã‚¹ãƒˆã—ãŸé–¢é€£ã®èª­ã¿è¾¼ã¿
const posts = await Post.findAll({
  include: [
    {
      model: User,
      as: 'author',
      attributes: ['id', 'name'],
      include: [{
        model: Profile,
        as: 'profile',
        attributes: ['avatar', 'bio']
      }]
    },
    {
      model: Comment,
      as: 'comments',
      limit: 5,
      order: [['createdAt', 'DESC']],
      include: [{
        model: User,
        as: 'user',
        attributes: ['id', 'name']
      }]
    }
  ]
});</code></pre>

                <h3>2. ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–</h3>
                <pre><code class="language-javascript">// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ´»ç”¨
// Mongooseã®å ´åˆ
userSchema.index({ email: 1 });
userSchema.index({ createdAt: -1 });
userSchema.index({ 'profile.location': '2dsphere' }); // åœ°ç†ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

// Sequelizeã®å ´åˆ
User.init({
  // ... fields
}, {
  indexes: [
    {
      unique: true,
      fields: ['email']
    },
    {
      fields: ['createdAt']
    },
    {
      type: 'FULLTEXT',
      fields: ['bio']
    }
  ]
});

// éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
Product.init({
  // ... fields
}, {
  indexes: [
    {
      fields: ['status', 'categoryId'],
      where: {
        status: 'active'
      }
    }
  ]
});

// è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é †åºã‚’è€ƒæ…®
// è‰¯ã„ä¾‹ï¼šã‚ˆã‚Šé¸æŠçš„ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…ˆã«
orderSchema.index({ status: 1, userId: 1, createdAt: -1 });

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å–å¾—
const users = await User.find({}, 'name email createdAt');

// Lean()ã§è»½é‡ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ï¼ˆMongooseï¼‰
const products = await Product
  .find({ status: 'active' })
  .select('name price')
  .lean(); // Mongooseãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ãªãã€ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™</code></pre>

                <h3>3. ãƒãƒƒãƒå‡¦ç†ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°</h3>
                <pre><code class="language-javascript">// ã‚«ãƒ¼ã‚½ãƒ«ã‚’ä½¿ã£ãŸå¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ï¼ˆMongoDBï¼‰
async function processLargeDataset() {
  const cursor = User.find({ isActive: true }).cursor();
  
  for (let user = await cursor.next(); user != null; user = await cursor.next()) {
    // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å€‹åˆ¥ã«å‡¦ç†
    await processUser(user);
  }
}

// ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼ˆPostgreSQLï¼‰
const { QueryTypes } = require('sequelize');
const stream = await sequelize.query(
  'SELECT * FROM products WHERE status = :status',
  {
    replacements: { status: 'active' },
    type: QueryTypes.SELECT,
    raw: true,
    stream: true
  }
);

stream.on('data', (product) => {
  // å„å•†å“ã‚’å‡¦ç†
  processProduct(product);
});

// ãƒãƒƒãƒå‡¦ç†
async function batchProcess(model, batchSize = 1000) {
  let offset = 0;
  let hasMore = true;
  
  while (hasMore) {
    const batch = await model.findAll({
      limit: batchSize,
      offset: offset,
      raw: true
    });
    
    if (batch.length === 0) {
      hasMore = false;
    } else {
      await processBatch(batch);
      offset += batchSize;
    }
  }
}</code></pre>

                <h3>4. æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®æœ€é©åŒ–</h3>
                <pre><code class="language-javascript">// MongoDBæ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®š
mongoose.connect(uri, {
  maxPoolSize: 10, // æœ€å¤§æ¥ç¶šæ•°
  minPoolSize: 2,  // æœ€å°æ¥ç¶šæ•°
  serverSelectionTimeoutMS: 5000,
  socketTimeoutMS: 45000,
});

// PostgreSQLæ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®š
const sequelize = new Sequelize({
  // ... other config
  pool: {
    max: 20,           // æœ€å¤§æ¥ç¶šæ•°
    min: 5,            // æœ€å°æ¥ç¶šæ•°
    acquire: 30000,    // æ¥ç¶šå–å¾—ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    idle: 10000,       // ã‚¢ã‚¤ãƒ‰ãƒ«æ¥ç¶šã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    evict: 1000,       // ã‚¢ã‚¤ãƒ‰ãƒ«æ¥ç¶šãƒã‚§ãƒƒã‚¯ã®é–“éš”
    validate: (client) => {
      // æ¥ç¶šã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
      return client.query('SELECT 1').then(() => true).catch(() => false);
    }
  }
});

// æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®ç›£è¦–
sequelize.connectionManager.pool.on('acquire', () => {
  console.log('Connection acquired');
});

sequelize.connectionManager.pool.on('release', () => {
  console.log('Connection released');
});</code></pre>

                <h3>5. ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
                <pre><code class="language-javascript">// æŸ”è»Ÿãªã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼
class QueryBuilder {
  constructor(model) {
    this.model = model;
    this.query = {};
    this.options = {
      limit: 20,
      offset: 0,
      order: [['createdAt', 'DESC']]
    };
  }
  
  where(conditions) {
    Object.assign(this.query, conditions);
    return this;
  }
  
  whereIn(field, values) {
    this.query[field] = { [Op.in]: values };
    return this;
  }
  
  whereBetween(field, min, max) {
    this.query[field] = { [Op.between]: [min, max] };
    return this;
  }
  
  whereText(fields, searchTerm) {
    this.query[Op.or] = fields.map(field => ({
      [field]: { [Op.iLike]: `%${searchTerm}%` }
    }));
    return this;
  }
  
  include(association) {
    if (!this.options.include) {
      this.options.include = [];
    }
    this.options.include.push(association);
    return this;
  }
  
  orderBy(field, direction = 'ASC') {
    this.options.order = [[field, direction]];
    return this;
  }
  
  limit(limit) {
    this.options.limit = limit;
    return this;
  }
  
  offset(offset) {
    this.options.offset = offset;
    return this;
  }
  
  paginate(page, perPage = 20) {
    this.options.limit = perPage;
    this.options.offset = (page - 1) * perPage;
    return this;
  }
  
  async execute() {
    const results = await this.model.findAndCountAll({
      where: this.query,
      ...this.options
    });
    
    return {
      data: results.rows,
      total: results.count,
      page: Math.floor(this.options.offset / this.options.limit) + 1,
      pages: Math.ceil(results.count / this.options.limit)
    };
  }
}

// ä½¿ç”¨ä¾‹
const results = await new QueryBuilder(Product)
  .where({ status: 'active' })
  .whereBetween('price', 100, 1000)
  .whereText(['name', 'description'], 'laptop')
  .include({
    model: Category,
    as: 'category'
  })
  .orderBy('price', 'DESC')
  .paginate(1, 20)
  .execute();</code></pre>
            </section>

            <!-- Database Design -->
            <section id="database-design" class="tutorial-section">
                <h2>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</h2>
                <p>åŠ¹ç‡çš„ã§æ‹¡å¼µå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®åŸå‰‡ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ã³ã¾ã™ã€‚</p>

                <h3>1. æ­£è¦åŒ–ã¨éæ­£è¦åŒ–</h3>
                <pre><code class="language-javascript">// æ­£è¦åŒ–ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ï¼‰
// ç¬¬3æ­£è¦å½¢ã¾ã§æ­£è¦åŒ–
const User = sequelize.define('User', {
  id: { type: DataTypes.UUID, primaryKey: true },
  email: { type: DataTypes.STRING, unique: true },
  username: { type: DataTypes.STRING, unique: true }
});

const UserProfile = sequelize.define('UserProfile', {
  userId: { type: DataTypes.UUID, references: { model: User } },
  firstName: DataTypes.STRING,
  lastName: DataTypes.STRING,
  bio: DataTypes.TEXT,
  avatar: DataTypes.STRING
});

const Address = sequelize.define('Address', {
  id: { type: DataTypes.UUID, primaryKey: true },
  userId: { type: DataTypes.UUID, references: { model: User } },
  type: DataTypes.ENUM('home', 'work', 'other'),
  street: DataTypes.STRING,
  city: DataTypes.STRING,
  state: DataTypes.STRING,
  country: DataTypes.STRING,
  zipCode: DataTypes.STRING
});

// éæ­£è¦åŒ–ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒï¼ˆNoSQLï¼‰
// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å„ªå…ˆã—ã¦ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã¿
const userSchema = new Schema({
  email: String,
  username: String,
  profile: {
    firstName: String,
    lastName: String,
    bio: String,
    avatar: String
  },
  addresses: [{
    type: { type: String, enum: ['home', 'work', 'other'] },
    street: String,
    city: String,
    state: String,
    country: String,
    zipCode: String
  }],
  // é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  stats: {
    postCount: { type: Number, default: 0 },
    followerCount: { type: Number, default: 0 },
    followingCount: { type: Number, default: 0 }
  }
});</code></pre>

                <h3>2. ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
                <pre><code class="language-javascript">// 1. ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£
const Comment = sequelize.define('Comment', {
  id: { type: DataTypes.UUID, primaryKey: true },
  content: DataTypes.TEXT,
  commentableId: DataTypes.UUID,
  commentableType: DataTypes.STRING, // 'Post', 'Product', 'User'
  userId: DataTypes.UUID
});

// ä½¿ç”¨ä¾‹
Comment.belongsTo(Post, {
  foreignKey: 'commentableId',
  constraints: false,
  as: 'post'
});

Comment.belongsTo(Product, {
  foreignKey: 'commentableId',
  constraints: false,
  as: 'product'
});

// 2. éšå±¤ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ„ãƒªãƒ¼æ§‹é€ ï¼‰
const Category = sequelize.define('Category', {
  id: { type: DataTypes.UUID, primaryKey: true },
  name: DataTypes.STRING,
  parentId: {
    type: DataTypes.UUID,
    references: { model: 'categories', key: 'id' }
  },
  path: DataTypes.STRING, // '/electronics/computers/laptops'
  depth: DataTypes.INTEGER
});

// Materialized Path Pattern
Category.beforeCreate((category) => {
  if (category.parentId) {
    const parent = await Category.findByPk(category.parentId);
    category.path = `${parent.path}/${category.name}`;
    category.depth = parent.depth + 1;
  } else {
    category.path = `/${category.name}`;
    category.depth = 0;
  }
});

// 3. ã‚¿ã‚°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå¤šå¯¾å¤šï¼‰
const Tag = sequelize.define('Tag', {
  id: { type: DataTypes.UUID, primaryKey: true },
  name: { type: DataTypes.STRING, unique: true },
  slug: { type: DataTypes.STRING, unique: true }
});

const PostTag = sequelize.define('PostTag', {
  postId: DataTypes.UUID,
  tagId: DataTypes.UUID,
  order: DataTypes.INTEGER
});

Post.belongsToMany(Tag, { through: PostTag });
Tag.belongsToMany(Post, { through: PostTag });

// 4. ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°
const Event = sequelize.define('Event', {
  id: { type: DataTypes.UUID, primaryKey: true },
  aggregateId: DataTypes.UUID,
  aggregateType: DataTypes.STRING,
  eventType: DataTypes.STRING,
  eventData: DataTypes.JSONB,
  userId: DataTypes.UUID,
  version: DataTypes.INTEGER,
  timestamp: DataTypes.DATE
}, {
  timestamps: false,
  indexes: [
    { fields: ['aggregateId', 'version'] },
    { fields: ['eventType'] },
    { fields: ['timestamp'] }
  ]
});</code></pre>

                <h3>3. æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®è¨­è¨ˆ</h3>
                <pre><code class="language-javascript">// æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ç”¨ã®ã‚¹ã‚­ãƒ¼ãƒ
const Metric = sequelize.define('Metric', {
  id: { type: DataTypes.BIGINT, autoIncrement: true, primaryKey: true },
  deviceId: DataTypes.STRING,
  metricType: DataTypes.STRING,
  value: DataTypes.FLOAT,
  timestamp: DataTypes.DATE,
  metadata: DataTypes.JSONB
}, {
  tableName: 'metrics',
  timestamps: false,
  indexes: [
    {
      fields: ['deviceId', 'timestamp']
    },
    {
      fields: ['metricType', 'timestamp']
    }
  ]
});

// ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆPostgreSQLï¼‰
await sequelize.query(`
  CREATE TABLE metrics_2024_01 PARTITION OF metrics
  FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
`);

// é›†è¨ˆç”¨ã®ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼
await sequelize.query(`
  CREATE MATERIALIZED VIEW hourly_metrics AS
  SELECT 
    deviceId,
    metricType,
    DATE_TRUNC('hour', timestamp) as hour,
    AVG(value) as avg_value,
    MIN(value) as min_value,
    MAX(value) as max_value,
    COUNT(*) as count
  FROM metrics
  GROUP BY deviceId, metricType, DATE_TRUNC('hour', timestamp);
  
  CREATE INDEX ON hourly_metrics (deviceId, hour);
`);</code></pre>

                <h3>4. ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ã‚·ãƒ¼</h3>
                <pre><code class="language-javascript">// ã‚¹ã‚­ãƒ¼ãƒãƒ¬ãƒ™ãƒ«ã®åˆ†é›¢
class TenantConnection {
  constructor() {
    this.connections = new Map();
  }
  
  async getConnection(tenantId) {
    if (!this.connections.has(tenantId)) {
      const config = {
        ...baseConfig,
        database: `tenant_${tenantId}`
      };
      
      const connection = new Sequelize(config);
      await connection.authenticate();
      
      this.connections.set(tenantId, connection);
    }
    
    return this.connections.get(tenantId);
  }
}

// è¡Œãƒ¬ãƒ™ãƒ«ã®åˆ†é›¢
const BaseModel = sequelize.define('BaseModel', {
  tenantId: {
    type: DataTypes.UUID,
    allowNull: false
  }
}, {
  hooks: {
    beforeFind: (options) => {
      // è‡ªå‹•çš„ã«tenantIdãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¿½åŠ 
      if (options.where && !options.where.tenantId) {
        options.where.tenantId = getCurrentTenantId();
      }
    }
  }
});

// ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä½¿ã£ãŸå®Ÿè£…
Product.addScope('tenant', (tenantId) => ({
  where: { tenantId }
}));

// ä½¿ç”¨
const products = await Product.scope({ method: ['tenant', tenantId] }).findAll();</code></pre>
            </section>

            <!-- Migrations -->
            <section id="migrations" class="tutorial-section">
                <h2>ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚’å®‰å…¨ã«ç®¡ç†ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚</p>

                <h3>1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬</h3>
                <pre><code class="language-bash"># Sequelizeãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ
npx sequelize-cli migration:generate --name add-user-table

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
npx sequelize-cli db:migrate

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
npx sequelize-cli db:migrate:undo

# ç‰¹å®šã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
npx sequelize-cli db:migrate:undo:all --to 20240101000000-create-user.js</code></pre>

                <h3>2. å®‰å…¨ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥</h3>
                <pre><code class="language-javascript">// ã‚«ãƒ©ãƒ ã®è¿½åŠ ï¼ˆå®‰å…¨ï¼‰
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.addColumn('users', 'phoneNumber', {
      type: Sequelize.STRING,
      allowNull: true, // æœ€åˆã¯NULLè¨±å¯
      defaultValue: null
    });
  },
  
  down: async (queryInterface, Sequelize) => {
    await queryInterface.removeColumn('users', 'phoneNumber');
  }
};

// ã‚«ãƒ©ãƒ ã®å‰Šé™¤ï¼ˆæ®µéšçš„ã«å®Ÿè¡Œï¼‰
// Step 1: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ä½¿ç”¨ã‚’å‰Šé™¤
// Step 2: ã‚«ãƒ©ãƒ ã‚’NULLè¨±å¯ã«å¤‰æ›´
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.changeColumn('users', 'oldColumn', {
      type: Sequelize.STRING,
      allowNull: true
    });
  }
};

// Step 3: å®Ÿéš›ã«ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.removeColumn('users', 'oldColumn');
  }
};

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ ï¼ˆCONCURRENTLYã‚’ä½¿ç”¨ï¼‰
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.sequelize.query(
      'CREATE INDEX CONCURRENTLY idx_users_email ON users(email);'
    );
  },
  
  down: async (queryInterface, Sequelize) => {
    await queryInterface.sequelize.query(
      'DROP INDEX CONCURRENTLY idx_users_email;'
    );
  }
};</code></pre>

                <h3>3. ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
                <pre><code class="language-javascript">// ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã‚’ä¼´ã†ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
module.exports = {
  up: async (queryInterface, Sequelize) => {
    // æ–°ã—ã„ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
    await queryInterface.addColumn('users', 'fullName', {
      type: Sequelize.STRING
    });
    
    // ãƒãƒƒãƒã§ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    const batchSize = 1000;
    let offset = 0;
    
    while (true) {
      const users = await queryInterface.sequelize.query(
        `SELECT id, "firstName", "lastName" FROM users 
         LIMIT :limit OFFSET :offset`,
        {
          replacements: { limit: batchSize, offset },
          type: Sequelize.QueryTypes.SELECT
        }
      );
      
      if (users.length === 0) break;
      
      // ãƒãƒ«ã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
      const updates = users.map(user => ({
        id: user.id,
        fullName: `${user.firstName} ${user.lastName}`
      }));
      
      await queryInterface.bulkUpdate('users', updates);
      
      offset += batchSize;
      console.log(`Updated ${offset} users...`);
    }
  },
  
  down: async (queryInterface, Sequelize) => {
    await queryInterface.removeColumn('users', 'fullName');
  }
};</code></pre>

                <h3>4. MongoDBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
                <pre><code class="language-javascript">// migrate-mongo ã®ä½¿ç”¨
const migration = {
  async up(db, client) {
    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä½œæˆ
    await db.createCollection('products');
    
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
    await db.collection('products').createIndex({ sku: 1 }, { unique: true });
    await db.collection('products').createIndex({ name: 'text', description: 'text' });
    
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
    await db.collection('users').updateMany(
      { role: { $exists: false } },
      { $set: { role: 'customer' } }
    );
    
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªãƒãƒ¼ãƒ 
    await db.collection('orders').updateMany(
      {},
      { $rename: { 'total': 'totalAmount' } }
    );
  },
  
  async down(db, client) {
    await db.collection('products').drop();
    await db.collection('orders').updateMany(
      {},
      { $rename: { 'totalAmount': 'total' } }
    );
  }
};

module.exports = migration;</code></pre>
            </section>

            <!-- Backup and Replication -->
            <section id="backup-replication" class="tutorial-section">
                <h2>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                <p>ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥ã¨ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šæ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚</p>

                <h3>1. PostgreSQLãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                <pre><code class="language-bash"># è«–ç†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆpg_dumpï¼‰
pg_dump -h localhost -U postgres -d myapp > backup.sql

# ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆåœ§ç¸®ï¼‰
pg_dump -h localhost -U postgres -d myapp -Fc > backup.dump

# ç‰¹å®šã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pg_dump -h localhost -U postgres -d myapp -t users -t orders > tables_backup.sql

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒªã‚¹ãƒˆã‚¢
psql -h localhost -U postgres -d myapp_restore < backup.sql

# ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒªã‚¹ãƒˆã‚¢
pg_restore -h localhost -U postgres -d myapp_restore backup.dump</code></pre>

                <h3>2. MongoDBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                <pre><code class="language-bash"># mongodumpã‚’ä½¿ç”¨ã—ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mongodump --host localhost --port 27017 --db myapp --out /backup/mongo/

# ç‰¹å®šã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mongodump --host localhost --port 27017 --db myapp --collection users

# åœ§ç¸®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mongodump --archive=myapp.archive --gzip --db myapp

# ãƒªã‚¹ãƒˆã‚¢
mongorestore --host localhost --port 27017 /backup/mongo/myapp/

# ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‹ã‚‰ã®ãƒªã‚¹ãƒˆã‚¢
mongorestore --archive=myapp.archive --gzip</code></pre>

                <h3>3. è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</h3>
                <p><strong>scripts/backup.js</strong></p>
                <pre><code class="language-javascript">const { spawn } = require('child_process');
const fs = require('fs').promises;
const path = require('path');
const AWS = require('aws-sdk');

const s3 = new AWS.S3();

class BackupManager {
  constructor(config) {
    this.config = config;
    this.backupDir = config.backupDir || '/tmp/backups';
  }
  
  async backupPostgres() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `postgres-backup-${timestamp}.dump`;
    const filepath = path.join(this.backupDir, filename);
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
    await fs.mkdir(this.backupDir, { recursive: true });
    
    // pg_dumpã®å®Ÿè¡Œ
    return new Promise((resolve, reject) => {
      const pgDump = spawn('pg_dump', [
        '-h', this.config.postgres.host,
        '-U', this.config.postgres.user,
        '-d', this.config.postgres.database,
        '-Fc',
        '-f', filepath
      ], {
        env: {
          ...process.env,
          PGPASSWORD: this.config.postgres.password
        }
      });
      
      pgDump.on('exit', (code) => {
        if (code === 0) {
          resolve(filepath);
        } else {
          reject(new Error(`pg_dump exited with code ${code}`));
        }
      });
    });
  }
  
  async backupMongoDB() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `mongodb-backup-${timestamp}.archive`;
    const filepath = path.join(this.backupDir, filename);
    
    return new Promise((resolve, reject) => {
      const mongoDump = spawn('mongodump', [
        '--uri', this.config.mongodb.uri,
        '--archive=' + filepath,
        '--gzip'
      ]);
      
      mongoDump.on('exit', (code) => {
        if (code === 0) {
          resolve(filepath);
        } else {
          reject(new Error(`mongodump exited with code ${code}`));
        }
      });
    });
  }
  
  async uploadToS3(filepath) {
    const fileStream = await fs.readFile(filepath);
    const filename = path.basename(filepath);
    
    const params = {
      Bucket: this.config.s3.bucket,
      Key: `backups/${filename}`,
      Body: fileStream,
      ServerSideEncryption: 'AES256'
    };
    
    const result = await s3.upload(params).promise();
    console.log(`Uploaded to S3: ${result.Location}`);
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    await fs.unlink(filepath);
    
    return result.Location;
  }
  
  async runBackup() {
    try {
      console.log('Starting backup process...');
      
      // PostgreSQLãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
      if (this.config.postgres) {
        const pgFile = await this.backupPostgres();
        await this.uploadToS3(pgFile);
        console.log('PostgreSQL backup completed');
      }
      
      // MongoDBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
      if (this.config.mongodb) {
        const mongoFile = await this.backupMongoDB();
        await this.uploadToS3(mongoFile);
        console.log('MongoDB backup completed');
      }
      
      // å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤
      await this.cleanupOldBackups();
      
      console.log('Backup process completed successfully');
    } catch (error) {
      console.error('Backup failed:', error);
      // é€šçŸ¥ã‚’é€ä¿¡
      await this.sendNotification('Backup failed', error.message);
    }
  }
  
  async cleanupOldBackups() {
    const retentionDays = this.config.retentionDays || 30;
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
    
    const params = {
      Bucket: this.config.s3.bucket,
      Prefix: 'backups/'
    };
    
    const objects = await s3.listObjectsV2(params).promise();
    
    const toDelete = objects.Contents
      .filter(obj => new Date(obj.LastModified) < cutoffDate)
      .map(obj => ({ Key: obj.Key }));
    
    if (toDelete.length > 0) {
      await s3.deleteObjects({
        Bucket: this.config.s3.bucket,
        Delete: { Objects: toDelete }
      }).promise();
      
      console.log(`Deleted ${toDelete.length} old backups`);
    }
  }
}

// Cronã‚¸ãƒ§ãƒ–ã¨ã—ã¦å®Ÿè¡Œ
const cron = require('node-cron');
const backupManager = new BackupManager(require('./backup-config'));

// æ¯æ—¥åˆå‰2æ™‚ã«å®Ÿè¡Œ
cron.schedule('0 2 * * *', async () => {
  await backupManager.runBackup();
});</code></pre>

                <h3>4. ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h3>
                <p><strong>MongoDB ãƒ¬ãƒ—ãƒªã‚«ã‚»ãƒƒãƒˆ</strong></p>
                <pre><code class="language-javascript">// ãƒ¬ãƒ—ãƒªã‚«ã‚»ãƒƒãƒˆæ¥ç¶š
mongoose.connect('mongodb://localhost:27017,localhost:27018,localhost:27019/myapp', {
  replicaSet: 'rs0',
  readPreference: 'secondaryPreferred', // èª­ã¿å–ã‚Šè² è·ã‚’åˆ†æ•£
  w: 'majority', // æ›¸ãè¾¼ã¿ç¢ºèª
  j: true, // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«æ›¸ãè¾¼ã¿
  wtimeout: 5000
});

// èª­ã¿å–ã‚Šè¨­å®šã®åˆ¶å¾¡
const User = mongoose.model('User', userSchema);

// ãƒ—ãƒ©ã‚¤ãƒãƒªã‹ã‚‰èª­ã¿å–ã‚Šï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªå ´åˆï¼‰
const user = await User.findById(userId).read('primary');

// ã‚»ã‚«ãƒ³ãƒ€ãƒªã‹ã‚‰èª­ã¿å–ã‚Šï¼ˆè² è·åˆ†æ•£ï¼‰
const users = await User.find({}).read('secondary');

// æœ€å¯„ã‚Šã®ãƒãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿å–ã‚Š
const products = await Product.find({}).read('nearest');</code></pre>

                <p><strong>PostgreSQL ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</strong></p>
                <pre><code class="language-bash"># ãƒ—ãƒ©ã‚¤ãƒãƒªã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šï¼ˆpostgresql.confï¼‰
wal_level = replica
max_wal_senders = 3
wal_keep_segments = 64
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/archive/%f'

# ã‚¹ã‚¿ãƒ³ãƒã‚¤ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®š
# 1. ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å–å¾—
pg_basebackup -h primary_host -D /var/lib/postgresql/data -U replicator -P -W

# 2. recovery.conf ã®ä½œæˆ
standby_mode = 'on'
primary_conninfo = 'host=primary_host port=5432 user=replicator'
trigger_file = '/tmp/postgresql.trigger'</code></pre>

                <h3>5. ç½å®³å¾©æ—§è¨ˆç”»</h3>
                <pre><code class="language-javascript">// å¾©æ—§æ‰‹é †ã®è‡ªå‹•åŒ–
class DisasterRecovery {
  async performHealthCheck() {
    const checks = {
      postgres: await this.checkPostgres(),
      mongodb: await this.checkMongoDB(),
      redis: await this.checkRedis()
    };
    
    return checks;
  }
  
  async checkPostgres() {
    try {
      await sequelize.authenticate();
      const [result] = await sequelize.query('SELECT 1');
      return { status: 'healthy', latency: result.time };
    } catch (error) {
      return { status: 'unhealthy', error: error.message };
    }
  }
  
  async initiateFailover() {
    console.log('Initiating failover process...');
    
    // 1. ãƒ—ãƒ©ã‚¤ãƒãƒªã®åœæ­¢ã‚’ç¢ºèª
    const primaryHealth = await this.checkPrimary();
    if (primaryHealth.status === 'healthy') {
      throw new Error('Primary is still healthy, aborting failover');
    }
    
    // 2. ã‚¹ã‚¿ãƒ³ãƒã‚¤ã‚’ãƒ—ãƒ©ã‚¤ãƒãƒªã«æ˜‡æ ¼
    await this.promoteStandby();
    
    // 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¥ç¶šå…ˆã‚’æ›´æ–°
    await this.updateConnectionStrings();
    
    // 4. é€šçŸ¥ã‚’é€ä¿¡
    await this.notifyTeam('Failover completed', {
      oldPrimary: this.config.primary,
      newPrimary: this.config.standby
    });
  }
  
  async performBackupRestore(backupId) {
    // 1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const backupPath = await this.downloadBackup(backupId);
    
    // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¾©å…ƒ
    await this.restoreDatabase(backupPath);
    
    // 3. æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    await this.verifyDataIntegrity();
    
    // 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†èµ·å‹•
    await this.restartApplication();
  }
}</code></pre>
            </section>

            <!-- Performance Tuning -->
            <section id="performance-tuning" class="tutorial-section">
                <h2>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
                <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€å¤§åŒ–ã™ã‚‹ãŸã‚ã®å®Ÿè·µçš„ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å­¦ã³ã¾ã™ã€‚</p>

                <h3>1. ã‚¯ã‚¨ãƒªã®åˆ†æã¨æœ€é©åŒ–</h3>
                <pre><code class="language-javascript">// PostgreSQL EXPLAINåˆ†æ
const analyzeQuery = async (query) => {
  const result = await sequelize.query(
    `EXPLAIN (ANALYZE, BUFFERS) ${query}`,
    { type: sequelize.QueryTypes.SELECT }
  );
  
  console.log('Query Plan:', result);
};

// ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãƒ­ã‚°ã®æœ‰åŠ¹åŒ–
sequelize.options.logging = (sql, timing) => {
  if (timing > 1000) { // 1ç§’ä»¥ä¸Šã‹ã‹ã‚‹ã‚¯ã‚¨ãƒª
    console.warn('Slow query detected:', {
      sql,
      duration: timing,
      timestamp: new Date()
    });
    
    // ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã‚’Redisã«è¨˜éŒ²
    redis.zadd('slow_queries', Date.now(), JSON.stringify({
      sql,
      duration: timing,
      timestamp: new Date()
    }));
  }
};

// MongoDB ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°
db.setProfilingLevel(1, { slowms: 100 }); // 100msä»¥ä¸Šã®ã‚¯ã‚¨ãƒªã‚’è¨˜éŒ²

// ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«çµæœã®åˆ†æ
const slowQueries = await db.collection('system.profile')
  .find({ millis: { $gt: 100 } })
  .sort({ ts: -1 })
  .limit(10)
  .toArray();</code></pre>

                <h3>2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–</h3>
                <pre><code class="language-javascript">// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨çŠ¶æ³ã®åˆ†æ
async function analyzeIndexUsage() {
  // PostgreSQL
  const pgIndexStats = await sequelize.query(`
    SELECT 
      schemaname,
      tablename,
      indexname,
      idx_scan,
      idx_tup_read,
      idx_tup_fetch,
      pg_size_pretty(pg_relation_size(indexrelid)) as index_size
    FROM pg_stat_user_indexes
    WHERE idx_scan = 0
    ORDER BY pg_relation_size(indexrelid) DESC;
  `, { type: sequelize.QueryTypes.SELECT });
  
  console.log('Unused indexes:', pgIndexStats);
  
  // MongoDB
  const collections = await db.listCollections().toArray();
  
  for (const collection of collections) {
    const stats = await db.collection(collection.name).aggregate([
      { $indexStats: {} }
    ]).toArray();
    
    const unusedIndexes = stats.filter(idx => 
      idx.accesses.ops === 0 && idx.name !== '_id_'
    );
    
    if (unusedIndexes.length > 0) {
      console.log(`Unused indexes in ${collection.name}:`, unusedIndexes);
    }
  }
}

// è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
// ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã®é«˜ã„é †ã«ä¸¦ã¹ã‚‹
userSchema.index({ status: 1, createdAt: -1, userId: 1 }); // æ‚ªã„ä¾‹
userSchema.index({ userId: 1, createdAt: -1, status: 1 }); // è‰¯ã„ä¾‹

// éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
await sequelize.query(`
  CREATE INDEX idx_active_products 
  ON products(name, price) 
  WHERE status = 'active';
`);</code></pre>

                <h3>3. æ¥ç¶šãƒ—ãƒ¼ãƒ«ã¨ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†</h3>
                <pre><code class="language-javascript">// æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®ç›£è¦–ã¨èª¿æ•´
class ConnectionPoolMonitor {
  constructor(sequelize, redis) {
    this.sequelize = sequelize;
    this.redis = redis;
    this.metrics = {
      acquired: 0,
      released: 0,
      pending: 0,
      failed: 0
    };
  }
  
  start() {
    const pool = this.sequelize.connectionManager.pool;
    
    pool.on('acquire', () => {
      this.metrics.acquired++;
      this.metrics.pending = pool.pending;
      this.logMetrics();
    });
    
    pool.on('release', () => {
      this.metrics.released++;
      this.logMetrics();
    });
    
    pool.on('error', () => {
      this.metrics.failed++;
      this.logMetrics();
    });
    
    // å®šæœŸçš„ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²
    setInterval(() => {
      this.saveMetrics();
    }, 60000); // 1åˆ†ã”ã¨
  }
  
  logMetrics() {
    const pool = this.sequelize.connectionManager.pool;
    console.log('Connection Pool Stats:', {
      size: pool.size,
      available: pool.available,
      using: pool.using,
      pending: pool.pending,
      ...this.metrics
    });
  }
  
  async saveMetrics() {
    const timestamp = Date.now();
    const pool = this.sequelize.connectionManager.pool;
    
    await this.redis.zadd('pool_metrics', timestamp, JSON.stringify({
      timestamp,
      size: pool.size,
      available: pool.available,
      using: pool.using,
      pending: pool.pending,
      ...this.metrics
    }));
  }
  
  async getPoolRecommendations() {
    const recentMetrics = await this.redis.zrange(
      'pool_metrics', 
      -100, 
      -1
    );
    
    const parsed = recentMetrics.map(m => JSON.parse(m));
    const avgPending = parsed.reduce((sum, m) => sum + m.pending, 0) / parsed.length;
    const maxUsing = Math.max(...parsed.map(m => m.using));
    
    const recommendations = [];
    
    if (avgPending > 5) {
      recommendations.push('æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºã‚’å¢—ã‚„ã™ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„');
    }
    
    if (maxUsing < pool.max * 0.5) {
      recommendations.push('æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™');
    }
    
    return recommendations;
  }
}</code></pre>

                <h3>4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æœ€é©åŒ–</h3>
                <pre><code class="language-javascript">// å¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
class MultiLayerCache {
  constructor(redis) {
    this.redis = redis;
    this.localCache = new Map();
    this.stats = {
      localHits: 0,
      redisHits: 0,
      misses: 0
    };
  }
  
  async get(key) {
    // L1: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥
    if (this.localCache.has(key)) {
      this.stats.localHits++;
      return this.localCache.get(key).value;
    }
    
    // L2: Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const redisValue = await this.redis.get(key);
    if (redisValue) {
      this.stats.redisHits++;
      const parsed = JSON.parse(redisValue);
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
      this.setLocal(key, parsed, 60); // 1åˆ†é–“
      
      return parsed;
    }
    
    this.stats.misses++;
    return null;
  }
  
  async set(key, value, ttl = 300) {
    // ä¸¡æ–¹ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    await this.redis.setex(key, ttl, JSON.stringify(value));
    this.setLocal(key, value, Math.min(ttl, 300)); // æœ€å¤§5åˆ†
  }
  
  setLocal(key, value, ttl) {
    this.localCache.set(key, {
      value,
      expires: Date.now() + (ttl * 1000)
    });
    
    // ãƒ¡ãƒ¢ãƒªåˆ¶é™ï¼ˆ1000ã‚¨ãƒ³ãƒˆãƒªï¼‰
    if (this.localCache.size > 1000) {
      const firstKey = this.localCache.keys().next().value;
      this.localCache.delete(firstKey);
    }
  }
  
  // æœŸé™åˆ‡ã‚Œã‚¨ãƒ³ãƒˆãƒªã®å‰Šé™¤
  cleanup() {
    const now = Date.now();
    for (const [key, entry] of this.localCache.entries()) {
      if (entry.expires < now) {
        this.localCache.delete(key);
      }
    }
  }
  
  getStats() {
    const total = this.stats.localHits + this.stats.redisHits + this.stats.misses;
    return {
      ...this.stats,
      hitRate: total > 0 ? (this.stats.localHits + this.stats.redisHits) / total : 0,
      localHitRate: total > 0 ? this.stats.localHits / total : 0
    };
  }
}

// ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æˆ¦ç•¥
class CacheWarmer {
  constructor(cache, models) {
    this.cache = cache;
    this.models = models;
  }
  
  async warmupPopularData() {
    console.log('Starting cache warmup...');
    
    // äººæ°—å•†å“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const popularProducts = await this.models.Product.findAll({
      where: { status: 'active' },
      order: [['views', 'DESC']],
      limit: 100
    });
    
    for (const product of popularProducts) {
      await this.cache.set(
        `product:${product.id}`,
        product.toJSON(),
        3600 // 1æ™‚é–“
      );
    }
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const categories = await this.models.Category.findAll({
      include: [{
        model: this.models.Product,
        as: 'products',
        where: { status: 'active' },
        required: false,
        attributes: ['id']
      }]
    });
    
    for (const category of categories) {
      await this.cache.set(
        `category:${category.id}`,
        category.toJSON(),
        7200 // 2æ™‚é–“
      );
    }
    
    console.log('Cache warmup completed');
  }
}</code></pre>

                <h3>5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šã®æœ€é©åŒ–</h3>
                <pre><code class="language-sql">-- PostgreSQL ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
-- postgresql.conf

-- ãƒ¡ãƒ¢ãƒªè¨­å®š
shared_buffers = '4GB'              -- ç·ãƒ¡ãƒ¢ãƒªã®25%ç¨‹åº¦
effective_cache_size = '12GB'       -- ç·ãƒ¡ãƒ¢ãƒªã®75%ç¨‹åº¦
work_mem = '64MB'                   -- ã‚½ãƒ¼ãƒˆ/ãƒãƒƒã‚·ãƒ¥æ“ä½œç”¨
maintenance_work_mem = '512MB'      -- VACUUM, CREATE INDEXç”¨

-- ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè¨­å®š
checkpoint_timeout = '15min'
checkpoint_completion_target = 0.9
wal_buffers = '16MB'

-- ä¸¦åˆ—å‡¦ç†
max_parallel_workers_per_gather = 4
max_parallel_workers = 8

-- çµ±è¨ˆæƒ…å ±
default_statistics_target = 100
random_page_cost = 1.1              -- SSDã®å ´åˆ</code></pre>

                <pre><code class="language-javascript">// MongoDB ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
// mongod.conf
{
  "systemLog": {
    "destination": "file",
    "path": "/var/log/mongodb/mongod.log",
    "logAppend": true
  },
  "storage": {
    "dbPath": "/var/lib/mongodb",
    "journal": {
      "enabled": true
    },
    "wiredTiger": {
      "engineConfig": {
        "cacheSizeGB": 4,
        "journalCompressor": "snappy"
      },
      "collectionConfig": {
        "blockCompressor": "zstd"
      }
    }
  },
  "net": {
    "bindIp": "0.0.0.0",
    "maxIncomingConnections": 1000
  },
  "operationProfiling": {
    "mode": "slowOp",
    "slowOpThresholdMs": 100
  }
}</code></pre>
            </section>

            <!-- Best Practices -->
            <section id="best-practices" class="tutorial-section">
                <h2>ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h2>
                <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–‹ç™ºã«ãŠã‘ã‚‹é‡è¦ãªåŸå‰‡ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚</p>

                <div class="best-practices-grid">
                    <div class="practice-item">
                        <h3>1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
                        <ul>
                            <li>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã®ä½¿ç”¨ï¼‰</li>
                            <li>æœ€å°æ¨©é™ã®åŸå‰‡ã«å¾“ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™è¨­å®š</li>
                            <li>æ¥ç¶šã®æš—å·åŒ–ï¼ˆSSL/TLSï¼‰</li>
                            <li>æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–</li>
                            <li>å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»</li>
                        </ul>
                    </div>
                    
                    <div class="practice-item">
                        <h3>2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                        <ul>
                            <li>é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¨­è¨ˆã¨ç®¡ç†</li>
                            <li>ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–ã¨EXPLAINåˆ†æ</li>
                            <li>æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®é©åˆ‡ãªè¨­å®š</li>
                            <li>ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å®Ÿè£…</li>
                            <li>å®šæœŸçš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–</li>
                        </ul>
                    </div>
                    
                    <div class="practice-item">
                        <h3>3. å¯ç”¨æ€§</h3>
                        <ul>
                            <li>ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š</li>
                            <li>è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã®å®Ÿè£…</li>
                            <li>å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒ†ã‚¹ãƒˆ</li>
                            <li>ç½å®³å¾©æ—§è¨ˆç”»ã®ç­–å®š</li>
                            <li>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…</li>
                        </ul>
                    </div>
                    
                    <div class="practice-item">
                        <h3>4. ä¿å®ˆæ€§</h3>
                        <ul>
                            <li>æ˜ç¢ºãªå‘½åè¦å‰‡ã®æ¡ç”¨</li>
                            <li>ã‚¹ã‚­ãƒ¼ãƒã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†</li>
                            <li>åŒ…æ‹¬çš„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</li>
                            <li>ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ•´å‚™</li>
                            <li>ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã®è¨­å®š</li>
                        </ul>
                    </div>
                </div>

                <h3>ã¾ã¨ã‚</h3>
                <p>ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ä¸»è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“ï¼ˆMongoDBã€PostgreSQLã€Redisï¼‰ã®å®Ÿè·µçš„ãªä½¿ç”¨æ–¹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é¸æŠã€åŠ¹ç‡çš„ãªè¨­è¨ˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–ã€ãã—ã¦ä¿¡é ¼æ€§ã®é«˜ã„é‹ç”¨æ–¹æ³•ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§å …ç‰¢ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
            </section>

            <!-- Navigation -->
            <div style="text-align: center; margin: 3rem 0;">
                <a href="express-generator-tutorial.html" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Express Generator
                </a>
                <a href="index.html" class="btn btn-outline-primary">
                    <i class="fas fa-home"></i> ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
                </a>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer style="background: #2c3e50; color: white; padding: 2rem 0; margin-top: 2rem;">
        <div class="container">
            <div style="text-align: center;">
                <div style="margin-bottom: 1rem;">
                    <a href="index.html" style="color: white; text-decoration: none; margin: 0 1rem;">ãƒ›ãƒ¼ãƒ </a>
                    <a href="nodejs-tutorial.html" style="color: white; text-decoration: none; margin: 0 1rem;">Node.jsåŸºç¤</a>
                    <a href="express-tutorial.html" style="color: white; text-decoration: none; margin: 0 1rem;">Express.js</a>
                    <a href="express-generator-tutorial.html" style="color: white; text-decoration: none; margin: 0 1rem;">Express Generator</a>
                    <a href="https://nodejs.org/" target="_blank" style="color: white; text-decoration: none; margin: 0 1rem;">Node.js å…¬å¼</a>
                    <a href="https://expressjs.com/" target="_blank" style="color: white; text-decoration: none; margin: 0 1rem;">Express.js å…¬å¼</a>
                </div>
                <p style="margin: 0;">&copy; 2024 Node.js Tutorial. ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯å­¦ç¿’ç›®çš„ã§ä½œæˆã•ã‚Œã¾ã—ãŸã€‚</p>
                <p style="margin: 0.5rem 0 0 0;">
                    <i class="fas fa-heart" style="color: #e74c3c;"></i> 
                    Made with Node.js and Express.js
                </p>
            </div>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" style="position: fixed; bottom: 20px; right: 20px; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; box-shadow: var(--shadow); display: none;" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script>
        // Initialize Prism for syntax highlighting
        document.addEventListener('DOMContentLoaded', function() {
            Prism.highlightAll();
            
            // Back to top button functionality
            const backToTopBtn = document.getElementById('backToTop');
            
            window.addEventListener('scroll', function() {
                if (window.scrollY > 300) {
                    backToTopBtn.style.display = 'block';
                } else {
                    backToTopBtn.style.display = 'none';
                }
            });
            
            // Mobile navigation toggle
            const navToggle = document.querySelector('.nav-toggle');
            const navMenu = document.querySelector('.nav-menu');
            
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }
        });
    </script>
</body>
</html>